<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Upload Test - DebugFlow</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #0a0a0a;
            color: #fff;
        }
        .test-container {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #4CAF50;
        }
        .test-result {
            background: #2a2a2a;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            border-left: 3px solid #666;
        }
        .test-result.success {
            border-left-color: #4CAF50;
            background: #0d2818;
        }
        .test-result.error {
            border-left-color: #f44336;
            background: #2d0a0a;
        }
        .test-result.pending {
            border-left-color: #ff9800;
            background: #2d1a0a;
        }
        h1 { color: #4CAF50; }
        h2 { color: #81C784; }
        h3 { color: #A5D6A7; }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 16px;
        }
        button:hover { background: #45a049; }
        button:disabled { 
            background: #666; 
            cursor: not-allowed; 
        }
        code {
            background: #2a2a2a;
            padding: 2px 6px;
            border-radius: 3px;
            color: #4CAF50;
        }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4CAF50;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .input-group {
            margin: 15px 0;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #ccc;
        }
        .input-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #555;
            border-radius: 4px;
            background: #2a2a2a;
            color: #fff;
            box-sizing: border-box;
        }
        .logs {
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            margin-top: 10px;
        }
        .log-entry {
            margin: 2px 0;
            padding: 2px 0;
        }
        .log-info { color: #81C784; }
        .log-error { color: #f44336; }
        .log-warn { color: #ff9800; }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background: #4CAF50; }
        .status-error { background: #f44336; }
        .status-pending { background: #ff9800; }
    </style>
</head>
<body>
    <h1>üß™ DebugFlow GitHub Upload Test Suite</h1>
    
    <div class="test-container">
        <h2>Production Environment Test</h2>
        <p>Testing GitHub repository upload against live DebugFlow API</p>
        
        <div class="input-group">
            <label for="testRepo">GitHub Repository URL:</label>
            <input type="text" id="testRepo" placeholder="https://github.com/owner/repository" value="https://github.com/facebook/react">
        </div>
        
        <div class="input-group">
            <label for="projectName">Project Name:</label>
            <input type="text" id="projectName" placeholder="My Test Project" value="React Repository Test">
        </div>
        
        <button onclick="runGitHubUploadTest()" id="testBtn">Run GitHub Upload Test</button>
        <button onclick="runAuthTest()">Test Authentication</button>
        <button onclick="clearLogs()">Clear Logs</button>
        <button onclick="window.open('https://debug-flow-complete-7lnj.vercel.app/upload', '_blank')">Open Live Upload Page</button>
    </div>

    <div id="test-results">
        <!-- Test results will be populated here -->
    </div>

    <div class="test-container">
        <h3>Test Logs</h3>
        <div id="logs" class="logs"></div>
    </div>

    <script>
        const API_BASE = 'https://debug-flow-complete-7lnj.vercel.app/api';
        let testResults = [];

        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logs.appendChild(logEntry);
            logs.scrollTop = logs.scrollHeight;
            console.log(`[${type.toUpperCase()}]`, message);
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
            document.getElementById('test-results').innerHTML = '';
        }

        function createTestResult(id, title, status = 'pending') {
            const container = document.getElementById('test-results');
            const testDiv = document.createElement('div');
            testDiv.id = id;
            testDiv.className = `test-result ${status}`;
            testDiv.innerHTML = `
                <h3><span class="status-indicator status-${status}"></span>${title}</h3>
                <p class="status">Status: <span class="status-text">${status}</span></p>
                <div class="details"></div>
            `;
            container.appendChild(testDiv);
            return testDiv;
        }

        function updateTestResult(id, status, details) {
            const testDiv = document.getElementById(id);
            if (!testDiv) return;
            
            testDiv.className = `test-result ${status}`;
            testDiv.querySelector('.status-indicator').className = `status-indicator status-${status}`;
            testDiv.querySelector('.status-text').textContent = status;
            
            if (details) {
                testDiv.querySelector('.details').innerHTML = details;
            }
        }

        // Mock authentication for testing
        function setupMockAuth() {
            if (!localStorage.getItem('debugflow_token')) {
                // Create a mock JWT token for testing
                const mockPayload = {
                    id: 1,
                    email: 'demo@debugflow.com',
                    name: 'Demo User',
                    iat: Math.floor(Date.now() / 1000),
                    exp: Math.floor(Date.now() / 1000) + (7 * 24 * 60 * 60) // 7 days
                };
                
                // Simple base64 encoding for demo (not secure, just for testing)
                const mockToken = 'mock-jwt-' + btoa(JSON.stringify(mockPayload));
                localStorage.setItem('debugflow_token', mockToken);
                localStorage.setItem('debugflow_user', JSON.stringify({
                    id: 1,
                    name: 'Demo User',
                    email: 'demo@debugflow.com'
                }));
                
                log('Mock authentication token set up', 'info');
            }
        }

        async function runAuthTest() {
            const testDiv = createTestResult('auth-test', 'Authentication Test');
            
            try {
                log('Testing authentication...', 'info');
                setupMockAuth();
                
                const token = localStorage.getItem('debugflow_token');
                log(`Using token: ${token.substring(0, 20)}...`, 'info');
                
                const response = await fetch(`${API_BASE}/health`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    updateTestResult('auth-test', 'success', `
                        <p><strong>‚úÖ Authentication working</strong></p>
                        <p>API Health: ${data.status}</p>
                        <p>Uptime: ${data.uptime}ms</p>
                    `);
                    log('Authentication test passed', 'info');
                    return true;
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
            } catch (error) {
                log(`Authentication test failed: ${error.message}`, 'error');
                updateTestResult('auth-test', 'error', `
                    <p><strong>‚ùå Authentication failed</strong></p>
                    <p>Error: ${error.message}</p>
                `);
                return false;
            }
        }

        async function runGitHubUploadTest() {
            const testBtn = document.getElementById('testBtn');
            testBtn.disabled = true;
            testBtn.textContent = 'Testing...';
            
            const testDiv = createTestResult('github-upload-test', 'GitHub Repository Upload Test');
            
            try {
                // Setup authentication
                setupMockAuth();
                
                const repoUrl = document.getElementById('testRepo').value;
                const projectName = document.getElementById('projectName').value;
                
                if (!repoUrl || !projectName) {
                    throw new Error('Please enter both repository URL and project name');
                }
                
                log(`Starting GitHub upload test for: ${repoUrl}`, 'info');
                
                // Prepare upload data
                const uploadData = {
                    projectName: projectName,
                    projectDescription: `Test import of ${repoUrl}`,
                    projectType: 'library',
                    uploadMethod: 'github',
                    githubRepo: repoUrl
                };
                
                log('Sending upload request...', 'info');
                
                // Send upload request
                const token = localStorage.getItem('debugflow_token');
                const response = await fetch(`${API_BASE}/upload`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(uploadData)
                });
                
                const responseText = await response.text();
                log(`Response status: ${response.status}`, 'info');
                log(`Response body: ${responseText}`, 'info');
                
                if (!response.ok) {
                    throw new Error(`Upload failed: ${response.status} ${response.statusText}\\nResponse: ${responseText}`);
                }
                
                const result = JSON.parse(responseText);
                
                if (result.success) {
                    log('Upload request successful!', 'info');
                    
                    updateTestResult('github-upload-test', 'success', `
                        <p><strong>‚úÖ GitHub upload successful!</strong></p>
                        <p>Project ID: <code>${result.data.project.id}</code></p>
                        <p>Status: <code>${result.data.project.status}</code></p>
                        <p>Upload Method: <code>${result.data.project.uploadMethod}</code></p>
                        <p>Source URL: <code>${result.data.project.sourceUrl}</code></p>
                        ${result.data.warnings ? `<p>Warnings: ${result.data.warnings.join(', ')}</p>` : ''}
                    `);
                    
                    // Test project retrieval
                    setTimeout(() => testProjectRetrieval(result.data.project.id), 2000);
                    
                } else {
                    throw new Error(result.message || 'Upload failed with unknown error');
                }
                
            } catch (error) {
                log(`GitHub upload test failed: ${error.message}`, 'error');
                updateTestResult('github-upload-test', 'error', `
                    <p><strong>‚ùå GitHub upload failed</strong></p>
                    <p>Error: ${error.message}</p>
                    <p>Check the console and logs for more details.</p>
                `);
            } finally {
                testBtn.disabled = false;
                testBtn.textContent = 'Run GitHub Upload Test';
            }
        }

        async function testProjectRetrieval(projectId) {
            const testDiv = createTestResult('project-retrieval-test', 'Project Retrieval Test');
            
            try {
                log(`Testing project retrieval for ID: ${projectId}`, 'info');
                
                const token = localStorage.getItem('debugflow_token');
                const response = await fetch(`${API_BASE}/projects?id=${projectId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to retrieve project: ${response.status} ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.success && result.data.project) {
                    const project = result.data.project;
                    log('Project retrieval successful!', 'info');
                    
                    updateTestResult('project-retrieval-test', 'success', `
                        <p><strong>‚úÖ Project retrieved successfully!</strong></p>
                        <p>Name: <code>${project.name}</code></p>
                        <p>Status: <code>${project.status}</code></p>
                        <p>Language: <code>${project.language}</code></p>
                        <p>File Count: <code>${project.file_count}</code></p>
                        <p>Created: <code>${project.created_at}</code></p>
                    `);
                } else {
                    throw new Error('Project not found in response');
                }
                
            } catch (error) {
                log(`Project retrieval test failed: ${error.message}`, 'error');
                updateTestResult('project-retrieval-test', 'error', `
                    <p><strong>‚ùå Project retrieval failed</strong></p>
                    <p>Error: ${error.message}</p>
                `);
            }
        }

        // Initialize
        window.onload = function() {
            log('GitHub Upload Test Suite initialized', 'info');
            log('Testing against production API: ' + API_BASE, 'info');
            
            // Run auth test on load
            setTimeout(runAuthTest, 1000);
        };
    </script>
</body>
</html>